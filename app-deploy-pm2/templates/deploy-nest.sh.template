#!/bin/bash
set -e

APP_NAME="wallet-api"
ENV="dev"
PM2_NAME="dev-wallet-api.9772424365.com"
PORT="6001"

BASE="/var/www/apps/$ENV/$APP_NAME"
ROOT="$BASE/current"
BACKUP="$BASE/backup"
ENV_FILE="$BASE/env/.env"
TEMP="$BASE/temp-build"

echo "ğŸš€ Deploying $APP_NAME (Standalone NestJS) for $ENV..."

# Clean temp
rm -rf "$TEMP"
mkdir -p "$TEMP"

# Clone branch
git clone --branch "$ENV" --depth=1 git@app-deploy:TRAVELIQWEB/wallet-auth.git "$TEMP"

# Copy env to project root
cp "$ENV_FILE" "$TEMP/.env"

# Install dependencies
cd "$TEMP"
npm ci --legacy-peer-deps

# Build NestJS
echo "ğŸ— Building NestJS..."
npm run build

# Ensure dist exists
if [ ! -f "$TEMP/dist/main.js" ]; then
  echo "âŒ Build failed: dist/main.js missing"
  exit 1
fi

echo "ğŸ“¦ Replacing old build..."
rm -rf "$BACKUP"
[ -d "$ROOT" ] && mv "$ROOT" "$BACKUP"
mv "$TEMP" "$ROOT"

# Restart PM2
echo "ğŸš€ Restarting PM2..."
pm2 stop "$PM2_NAME" || true
pm2 delete "$PM2_NAME" || true
fuser -k $PORT/tcp || true
sleep 1

pm2 start "node dist/main.js" \
  --name "$PM2_NAME" \
  --cwd "$ROOT"

echo "ğŸ‰ Deployment Complete!"
