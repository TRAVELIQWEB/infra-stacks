#!/bin/bash
set -e

APP_NAME="__APP_NAME__"
ENV="__ENV__"
PM2_NAME="__PM2_NAME__"
PORT="__PORT__"

# Folder structure (same as existing)
BASE="/var/www/apps/$ENV/$APP_NAME"
ROOT="$BASE/current"
BACKUP="$BASE/backup"
TEMP="$BASE/temp"

# Artifact passed from CI
BUILD_ARCHIVE="$1"

echo "üöÄ Deploying $APP_NAME (Next.js Standalone ‚Äì Artifact mode) for $ENV..."

############################################
# 1. Validate artifact
############################################
if [ -z "$BUILD_ARCHIVE" ]; then
  echo "‚ùå Build archive argument missing"
  echo "Usage: deploy.sh <artifact.tar.gz>"
  exit 1
fi

if [ ! -f "$BUILD_ARCHIVE" ]; then
  echo "‚ùå Build archive not found: $BUILD_ARCHIVE"
  exit 1
fi

############################################
# 2. Prepare temp directory
############################################
rm -rf "$TEMP"
mkdir -p "$TEMP"

############################################
# 3. Extract build artifact
############################################
echo "üì¶ Extracting build artifact..."
tar -xzf "$BUILD_ARCHIVE" -C "$TEMP"

# Safety check
if [ ! -d "$TEMP/.next" ]; then
  echo "‚ùå Invalid artifact: .next folder missing"
  exit 1
fi

############################################
# 4. Blue-Green swap
############################################
echo "üîÅ Performing blue-green swap..."

rm -rf "$BACKUP"
[ -d "$ROOT" ] && mv "$ROOT" "$BACKUP"
mv "$TEMP" "$ROOT"

############################################
# 5. Load private env (server-only)
############################################
ENV_FILE="$BASE/env/.env"

if [ ! -f "$ENV_FILE" ]; then
  echo "‚ùå Private env file missing: $ENV_FILE"
  exit 1
fi

echo "üîê Loading private env variables..."
export $(grep -v '^#' "$ENV_FILE" | xargs)

############################################
# 5. Restart / Reload PM2
############################################
echo "üöÄ Restarting PM2..."

pm2 reload "$PM2_NAME" || \
pm2 start npm \
  --name "$PM2_NAME" \
  --cwd "$ROOT" \
  --update-env \
  --env production \
  -- start -- -p "$PORT"

echo "‚úÖ Deployment complete for $APP_NAME"
